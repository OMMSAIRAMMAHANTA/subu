<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Om Sai Hostel - Secure Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- GLOBAL VARIABLES --- */
        :root {
            --primary: #003366; --accent: #0066cc; --bg: #f4f6f9;
            --white: #ffffff; --text-dark: #2c3e50; --text-light: #7f8c8d;
            --success: #27ae60; --danger: #c0392b; --border: #e1e4e8;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text-dark); }

        /* --- LOGIN SCREEN --- */
        #login-section {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #003366, #000000);
            z-index: 5000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white;
        }
        .login-box {
            background: white; color: #333; padding: 30px; border-radius: 15px;
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .login-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .login-tab { flex: 1; padding: 10px; cursor: pointer; font-weight: bold; color: #888; transition: 0.3s; }
        
        /* Active Tab Style */
        .login-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #f0f8ff; }
        
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .btn-login { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 10px; }

        .password-wrapper { position: relative; width: 100%; margin: 10px 0; }
        .password-wrapper input { margin: 0; width: 100%; padding-right: 40px; }
        .toggle-password { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #666; font-size: 1.1rem; }

        /* --- PANELS --- */
        #admin-panel, #student-panel { display: none; padding-bottom: 60px; }

        header {
            background: var(--primary); color: var(--white);
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 100;
        }
        .brand { display: flex; align-items: center; gap: 10px; }
        .brand i { font-size: 1.5rem; color: #ffcc00; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }

        /* TABS & SECTIONS */
        .nav-tabs { display: flex; background: var(--white); padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .nav-btn { flex: 1; border: none; background: none; padding: 12px; font-weight: 600; color: var(--text-light); cursor: pointer; border-radius: 6px; transition: 0.3s; }
        .nav-btn.active { background: var(--accent); color: var(--white); }

        .section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* STATS & CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--white); padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--accent); }
        .stat-num { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 0.85rem; color: var(--text-light); }

        .total-amount-box {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white; padding: 20px; border-radius: 12px; text-align: center;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        .total-amount-label { font-size: 1rem; opacity: 0.9; }
        .total-amount-value { font-size: 2.5rem; font-weight: bold; margin-top: 5px; }

        .form-card { background: var(--white); padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; color: var(--text-dark); }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; outline: none; box-sizing: border-box; }
        .btn-primary { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }

        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .room-card { background: var(--white); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid var(--border); cursor: pointer; position: relative; overflow: hidden; }
        .room-card.full { background: #fff5f5; border-color: #feb2b2; }
        .room-number { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        .room-capacity { font-size: 0.85rem; color: var(--text-light); margin-top: 5px; }
        
        .room-progress { height: 4px; background: #eee; margin-top: 10px; border-radius: 2px; overflow: hidden; }
        .room-bar { height: 100%; background: var(--accent); transition: width 0.3s; }
        .room-bar.full { background: var(--danger); }

        .student-card { background: var(--white); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border); cursor: pointer; }
        .st-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); }
        .st-details { flex: 1; }
        .st-name { font-weight: 700; color: var(--text-dark); }
        .st-sub { font-size: 0.85rem; color: var(--text-light); }
        .st-badge { font-size: 0.7rem; font-weight: bold; padding: 2px 8px; border-radius: 12px; }
        .bg-paid { background: #e8f5e9; color: var(--success); }
        .bg-due { background: #fceceb; color: var(--danger); }

        .expense-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--danger); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .exp-del-btn { color: #bbb; cursor: pointer; padding: 5px; }
        .exp-del-btn:hover { color: var(--danger); }

        .student-profile-header { text-align: center; background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .sp-img { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--primary); object-fit: cover; }
        .sp-name { font-size: 1.5rem; font-weight: bold; margin: 10px 0 5px; }
        .sp-detail { color: #666; font-size: 0.9rem; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; padding: 15px; }
        #room-modal { z-index: 2000; }
        #student-modal { z-index: 2100; }

        .modal { background: var(--white); width: 100%; max-width: 450px; border-radius: 12px; overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        /* Details Box */
        .details-box { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e1e4e8; font-size: 0.95rem; color: #333; }
        .details-box p { margin: 8px 0; border-bottom: 1px dashed #ddd; padding-bottom: 5px; display: flex; justify-content: space-between; }
        .details-box p:last-child { border: none; }
        .d-label { color: var(--text-light); font-weight: 600; }
        .d-val { font-weight: bold; color: var(--text-dark); }

        .pay-status-box { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); }
        .btn-pay { width: 100%; padding: 10px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-pay:disabled { background: #bdc3c7; cursor: not-allowed; }

        .history-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .history-table th { text-align: left; color: var(--text-light); border-bottom: 1px solid var(--border); padding: 5px; }
        .history-table td { padding: 8px 5px; border-bottom: 1px solid #f1f1f1; }
        
        .flex-row { display: flex; gap: 10px; }
        .file-input-wrapper { border: 2px dashed var(--border); padding: 20px; text-align: center; border-radius: 8px; color: var(--text-light); cursor: pointer; }
        #preview-img { max-width: 100%; height: 100px; object-fit: contain; display: none; margin: 10px auto; }

        .sidebar-section { background: var(--white); padding: 15px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .btn-backup { background: #2ecc71; color: white; padding: 10px; width: 100%; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .btn-restore { background: #e67e22; color: white; padding: 10px; width: 100%; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .edit-icon { color: var(--accent); cursor: pointer; margin-left: 10px; font-size: 0.9rem; }

    </style>
</head>
<body>

    <div id="login-section">
        <div style="font-size: 3rem; color: #ffcc00; margin-bottom: 10px;"><i class="fa-solid fa-building-shield"></i></div>
        <h2 style="margin-bottom: 20px;">Om Sai Hostel Portal</h2>
        <div class="login-box">
            <div class="login-tabs">
                <div class="login-tab active" onclick="switchLogin('admin')" id="tab-admin">Admin Login</div>
                <div class="login-tab" onclick="switchLogin('student')" id="tab-student">Student Login</div>
            </div>
            
            <div id="form-admin">
                <input type="text" id="admin-id" class="login-input" placeholder="Admin ID">
                <div class="password-wrapper">
                    <input type="password" id="admin-pass" class="login-input" placeholder="Password">
                    <i class="fa-solid fa-eye toggle-password" onclick="togglePassword('admin-pass')"></i>
                </div>
                <button class="btn-login" onclick="adminLogin()">Login as Admin</button>
            </div>

            <div id="form-student" style="display: none;">
                <p style="color:#666; font-size:0.9rem; margin-bottom:5px;">Enter your Password (T-Number)</p>
                <div class="password-wrapper">
                    <input type="password" id="student-pass" class="login-input" placeholder="Enter Password">
                    <i class="fa-solid fa-eye toggle-password" onclick="togglePassword('student-pass')"></i>
                </div>
                <button class="btn-login" onclick="studentLogin()">Login</button>
            </div>
            <p id="login-error" style="color: red; font-size: 0.9rem; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="admin-panel">
        <header>
            <div class="brand">
                <i class="fa-solid fa-user-tie"></i>
                <div><h2 id="admin-welcome">Admin Dashboard</h2><div style="font-size:0.7rem;">Om Sai Hostel</div></div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout <i class="fa-solid fa-right-from-bracket"></i></button>
        </header>

        <div class="container">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-num" id="total-students">0</div><div class="stat-label">Total Students</div></div>
                <div class="stat-card"><div class="stat-num" id="total-rooms">0</div><div class="stat-label">Total Rooms</div></div>
            </div>

            <div class="nav-tabs">
                <button class="nav-btn active" onclick="showTab('dashboard')">Dashboard</button>
                <button class="nav-btn" onclick="showTab('rooms')">Rooms</button>
                <button class="nav-btn" onclick="showTab('expenses')">Expenses</button>
                <button class="nav-btn" onclick="showTab('admission')">Admission</button>
            </div>

            <div id="sec-dashboard" class="section active">
                <input type="text" id="search-inp" class="search-box" placeholder="Search Student..." onkeyup="renderDashboard()">
                <div id="student-list"></div>
                
                <div class="sidebar-section">
                    <h4 style="margin-top:0; color:var(--text-dark);">Data Backup</h4>
                    <button class="btn-backup" onclick="downloadBackup()"><i class="fa-solid fa-download"></i> Backup</button>
                    <button class="btn-restore" onclick="document.getElementById('restore-file').click()"><i class="fa-solid fa-upload"></i> Restore</button>
                    <input type="file" id="restore-file" style="display: none;" onchange="restoreBackup(this)">
                </div>
            </div>

            <div id="sec-rooms" class="section">
                <div class="form-card" style="margin-bottom: 20px;">
                    <h3 style="margin-top:0;">Add Room</h3>
                    <div class="flex-row">
                        <input type="text" id="new-r-no" placeholder="Room No">
                        <input type="number" id="new-r-cap" placeholder="Capacity">
                    </div>
                    <button class="btn-primary" onclick="addRoom()">Create Room</button>
                </div>
                <div id="room-grid" class="room-grid"></div>
            </div>

            <div id="sec-expenses" class="section">
                <div class="form-card" style="margin-bottom:15px;">
                    <h4>Add Expense</h4>
                    <div class="flex-row">
                        <input type="text" id="exp-desc" placeholder="Description">
                        <input type="number" id="exp-amt" placeholder="Amount (‚Çπ)">
                    </div>
                    <button class="btn-primary" onclick="addExpense()">Add Expense</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card sc-green"><div class="stat-num" id="stat-income">‚Çπ0</div><div class="stat-label">Income</div></div>
                    <div class="stat-card sc-red"><div class="stat-num" id="stat-expense">‚Çπ0</div><div class="stat-label">Expense</div></div>
                    <div class="stat-card"><div class="stat-num" id="stat-profit">‚Çπ0</div><div class="stat-label">Profit</div></div>
                </div>
                <div id="expense-list"></div>
            </div>

            <div id="sec-admission" class="section">
                <div class="form-card">
                    <h3 style="margin-top:0; color:var(--primary);">Admission Form</h3>
                    <div class="form-group"><label>T-Number (Password)</label><input type="text" id="adm-tnum" placeholder="Example: T-101"></div>
                    <div class="form-group"><label>Room</label><select id="adm-room"><option value="">Select Room</option></select></div>
                    <div class="form-group"><label>Name</label><input type="text" id="adm-name"></div>
                    <div class="flex-row">
                        <div class="form-group" style="flex:1"><label>Mobile</label><input type="number" id="adm-mobile"></div>
                        <div class="form-group" style="flex:1"><label>Rent Amount (‚Çπ)</label><input type="number" id="adm-rent" placeholder="5000"></div>
                    </div>
                    <div class="form-group"><label>Parent Name</label><input type="text" id="adm-parent"></div>
                    <div class="form-group"><label>Join Date</label><input type="date" id="adm-date"></div>
                    <div class="form-group"><label>Photo</label>
                        <div class="file-input-wrapper" onclick="document.getElementById('adm-photo').click()"><i class="fa-solid fa-cloud-upload-alt"></i> Upload</div>
                        <input type="file" id="adm-photo" hidden accept="image/*" onchange="previewImage(this)">
                        <img id="preview-img">
                    </div>
                    <button class="btn-primary" onclick="registerStudent()">Register</button>
                </div>
            </div>
        </div>
    </div>

    <div id="student-panel">
        <header>
            <div class="brand"><i class="fa-solid fa-user-graduate"></i><div><h2>Student Portal</h2><div style="font-size:0.7rem;">Om Sai Hostel</div></div></div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </header>
        <div class="container">
            <div class="student-profile-header">
                <img id="sp-img" class="sp-img" src="">
                <h2 id="sp-name" class="sp-name"></h2>
                <div class="sp-detail" id="sp-tnum"></div>
                <div class="sp-detail" id="sp-room"></div>
            </div>
            <div class="total-amount-box">
                <div class="total-amount-label">Monthly Rent</div>
                <div class="total-amount-value" id="sp-amount">‚Çπ0</div>
            </div>
            <div class="form-card">
                <h3 style="border-bottom:1px solid #eee; padding-bottom:10px;">Payment Status (<span id="sp-curr-month"></span>)</h3>
                <div id="sp-status-display" style="font-size: 1.5rem; font-weight: bold; margin: 20px 0; text-align: center;"></div>
                <h4 style="margin-top: 30px;">History</h4>
                <table class="history-table"><thead><tr><th>Month</th><th>Date</th></tr></thead><tbody id="sp-history"></tbody></table>
            </div>
        </div>
    </div>

    <div id="student-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>Student Profile</h3><i class="fa-solid fa-times" onclick="closeModal('student-modal')" style="cursor:pointer;"></i></div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:15px;">
                    <img id="m-img" style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--border);">
                    <h3 id="m-name" style="margin:5px 0; color:var(--primary);"></h3>
                    <div id="m-tnum" style="font-weight:bold; color:var(--text-dark);"></div>
                    <div id="m-room" style="color:var(--text-light);"></div>
                    <div style="color:green; font-weight:bold; margin-top:5px;">
                        <span id="m-rent-display"></span> 
                        <i class="fa-solid fa-pen-to-square edit-icon" onclick="editRent()" title="Edit Rent"></i>
                    </div>
                </div>

                <div class="details-box">
                    <p><span class="d-label">üìû Mobile:</span> <span class="d-val" id="m-mobile"></span></p>
                    <p><span class="d-label">üë®‚Äçüë©‚Äçüë¶ Parent:</span> <span class="d-val" id="m-parent"></span></p>
                    <p><span class="d-label">üìÖ Joined:</span> <span class="d-val" id="m-join"></span></p>
                </div>

                <div class="pay-status-box">
                    <div style="font-size:0.8rem;">Status: <span id="m-curr-month"></span></div>
                    <div id="m-status-text" style="font-size:1.2rem; font-weight:bold; margin:10px 0;"></div>
                    <button id="btn-pay" style="width:100%; padding:10px; background:var(--success); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;" onclick="processPayment()">Accept Payment</button>
                </div>

                <h4>History</h4>
                <div style="max-height:150px; overflow-y:auto;"><table class="history-table"><tbody id="m-history"></tbody></table></div>
                
                <button onclick="deleteStudent()" style="width:100%; margin-top:15px; padding:10px; background:var(--danger); color:white; border:none; border-radius:6px; cursor:pointer;">Delete Student</button>
            </div>
        </div>
    </div>

    <div id="room-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>Room Details</h3><i class="fa-solid fa-times" onclick="closeModal('room-modal')" style="cursor:pointer;"></i></div>
            <div class="modal-body">
                <p id="rm-stats" style="color:var(--text-light); margin-bottom:15px;"></p>
                <h4 style="color:var(--primary);">Students in Room:</h4>
                <div id="rm-list"></div>
                <div style="margin-top:20px; text-align:center;">
                    <button onclick="deleteRoom()" style="background:transparent; color:var(--danger); border:1px solid var(--danger); padding:8px; border-radius:6px; cursor:pointer;">Delete Room</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        let students = JSON.parse(localStorage.getItem('omSaiStudents')) || [];
        let rooms = JSON.parse(localStorage.getItem('omSaiRooms')) || [];
        let expenses = JSON.parse(localStorage.getItem('omSaiExpenses')) || [];
        
        let activeStudentId = null;
        let activeRoomNo = null;
        
        const ADMINS = [
            { id: "debi", pass: "prasad@426", name: "Debi Prasad Swin" },
            { id: "omm",  pass: "sai@426",    name: "Omm Sairam Mahanta" }
        ];

        const now = new Date();
        const currentMonth = `${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][now.getMonth()]} ${now.getFullYear()}`;

        function togglePassword(id) {
            const x = document.getElementById(id);
            if (x.type === "password") { x.type = "text"; } else { x.type = "password"; }
        }

        function switchLogin(type) {
            document.getElementById('login-error').innerText = "";
            document.getElementById('tab-admin').classList.toggle('active', type==='admin');
            document.getElementById('tab-student').classList.toggle('active', type==='student');
            document.getElementById('form-admin').style.display = type==='admin' ? 'block' : 'none';
            document.getElementById('form-student').style.display = type==='student' ? 'block' : 'none';
        }

        function adminLogin() {
            const id = document.getElementById('admin-id').value.trim();
            const pass = document.getElementById('admin-pass').value.trim();
            const admin = ADMINS.find(a => a.id === id && a.pass === pass);
            if(admin) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('admin-welcome').innerText = "Welcome, " + admin.name;
                initAdmin();
            } else { document.getElementById('login-error').innerText = "Wrong ID or Password!"; }
        }

        function studentLogin() {
            const pass = document.getElementById('student-pass').value.trim();
            const student = students.find(s => s.tNumber === pass);
            if(student) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('student-panel').style.display = 'block';
                loadStudentDashboard(student);
            } else { document.getElementById('login-error').innerText = "Invalid Password (T-Number)!"; }
        }

        function logout() { location.reload(); }

        /* STUDENT VIEW */
        function loadStudentDashboard(s) {
            document.getElementById('sp-name').innerText = s.name;
            document.getElementById('sp-tnum').innerText = "ID: " + s.tNumber;
            document.getElementById('sp-room').innerText = "Room: " + s.room;
            document.getElementById('sp-img').src = s.image || 'https://via.placeholder.com/100';
            document.getElementById('sp-curr-month').innerText = currentMonth;
            document.getElementById('sp-amount').innerText = "‚Çπ" + (s.rent || 0);

            const isPaid = s.payments.some(p => p.month === currentMonth);
            document.getElementById('sp-status-display').innerHTML = isPaid ? `<span style="color:var(--success)">‚úÖ PAID</span>` : `<span style="color:var(--danger)">‚ùå PENDING</span>`;
            const hist = document.getElementById('sp-history');
            hist.innerHTML = '';
            s.payments.slice().reverse().forEach(p => { hist.innerHTML += `<tr><td>${p.month}</td><td>${p.date}</td></tr>`; });
        }

        /* ADMIN VIEW */
        function initAdmin() { renderDashboard(); renderRooms(); renderExpenses(); updateStats(); }
        function showTab(t) {
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById('sec-'+t).classList.add('active');
            event.currentTarget.classList.add('active');
            if(t==='rooms') renderRooms();
            if(t==='admission') loadRoomDropdown();
            if(t==='expenses') renderExpenses();
        }

        function loadRoomDropdown() {
            const s = document.getElementById('adm-room'); s.innerHTML = '<option value="">Select Room</option>';
            rooms.forEach(r => {
                if(students.filter(st=>st.room == r.no).length < r.cap) {
                    let o = document.createElement('option'); o.value = r.no; o.innerText = `Room ${r.no}`; s.appendChild(o);
                }
            });
        }

        function registerStudent() {
            const tnum=document.getElementById('adm-tnum').value, room=document.getElementById('adm-room').value, name=document.getElementById('adm-name').value;
            const mobile=document.getElementById('adm-mobile').value, parent=document.getElementById('adm-parent').value, date=document.getElementById('adm-date').value;
            const rent=document.getElementById('adm-rent').value;
            const img = document.getElementById('preview-img').src;
            
            if(!tnum || !room || !name || !rent) return alert("Required fields missing");
            if(students.some(s=>s.tNumber===tnum)) return alert("T-Number exists");
            
            students.push({ id: Date.now(), tNumber: tnum, name, room, mobile, parent, date, rent, image: img.includes('base64') ? img : '', payments: [] });
            saveData(); alert("Added!"); document.getElementById('adm-tnum').value=''; renderDashboard();
        }

        function previewImage(i) {
            const r = new FileReader(); r.onload = e => { document.getElementById('preview-img').src = e.target.result; document.getElementById('preview-img').style.display='block'; };
            if(i.files[0]) r.readAsDataURL(i.files[0]);
        }

        function renderDashboard() {
            const l = document.getElementById('student-list'), q = document.getElementById('search-inp').value.toLowerCase();
            l.innerHTML = '';
            students.filter(s=>s.name.toLowerCase().includes(q) || s.tNumber.toLowerCase().includes(q)).forEach(s => {
                const paid = s.payments.some(p=>p.month===currentMonth);
                l.innerHTML += `
                <div class="student-card" onclick="openAdminProfile(${s.id})">
                    <img src="${s.image||'https://via.placeholder.com/50'}" class="st-img">
                    <div class="st-info">
                        <div class="st-name">${s.name}</div>
                        <div class="st-details">${s.tNumber} | Room: ${s.room}</div>
                    </div>
                    <span class="st-badge ${paid?'bg-paid':'bg-due'}">${paid?'PAID':'DUE'}</span>
                </div>`;
            });
            updateStats();
        }

        function openAdminProfile(id) {
            activeStudentId = id; const s = students.find(x=>x.id===id);
            document.getElementById('m-name').innerText = s.name;
            document.getElementById('m-tnum').innerText = s.tNumber;
            document.getElementById('m-room').innerText = "Room " + s.room;
            document.getElementById('m-rent-display').innerText = "Rent: ‚Çπ" + (s.rent || 0);
            document.getElementById('m-img').src = s.image || 'https://via.placeholder.com/100';
            document.getElementById('m-curr-month').innerText = currentMonth;
            
            // FIXED: Populate missing fields
            document.getElementById('m-mobile').innerText = s.mobile || "N/A";
            document.getElementById('m-parent').innerText = s.parent || "N/A";
            document.getElementById('m-join').innerText = s.date || "N/A";

            const paid = s.payments.some(p=>p.month===currentMonth);
            document.getElementById('m-status-text').innerHTML = paid ? `<span style="color:var(--success)">PAID ‚úÖ</span>` : `<span style="color:var(--danger)">PENDING ‚ùå</span>`;
            const btn = document.getElementById('btn-pay');
            if(paid) { btn.innerText="Received"; btn.disabled=true; btn.style.background="#ccc"; } 
            else { btn.innerText="Accept Payment"; btn.disabled=false; btn.style.background="var(--success)"; }
            
            const h = document.getElementById('m-history'); h.innerHTML='';
            s.payments.slice().reverse().forEach(p=>{ h.innerHTML+=`<tr><td>${p.month}</td><td>${p.date}</td></tr>`; });
            
            document.getElementById('room-modal').style.display = 'none';
            document.getElementById('student-modal').style.display = 'flex';
        }

        function editRent() {
            if(!activeStudentId) return;
            const s = students.find(x => x.id === activeStudentId);
            const newRent = prompt("Enter New Rent Amount (‚Çπ):", s.rent);
            if(newRent && !isNaN(newRent)) {
                s.rent = newRent;
                saveData();
                document.getElementById('m-rent-display').innerText = "Rent: ‚Çπ" + s.rent;
                alert("Rent Updated!");
            }
        }

        function processPayment() {
            const i = students.findIndex(x=>x.id===activeStudentId);
            students[i].payments.push({ month: currentMonth, date: new Date().toLocaleDateString() });
            saveData(); openAdminProfile(activeStudentId); renderDashboard();
        }

        function deleteStudent() {
            if(confirm("Delete?")) { students = students.filter(x=>x.id!==activeStudentId); saveData(); closeModal('student-modal'); renderDashboard(); }
        }

        function addRoom() {
            const no = document.getElementById('new-r-no').value, cap = document.getElementById('new-r-cap').value;
            if(!no||!cap) return; if(rooms.some(r=>r.no===no)) return alert("Exists");
            rooms.push({no, cap: parseInt(cap)}); saveData(); renderRooms();
        }

        function renderRooms() {
            const g = document.getElementById('room-grid'); g.innerHTML='';
            rooms.sort((a,b)=>a.no-b.no).forEach(r => {
                const c = students.filter(s=>s.room==r.no).length;
                const pct = (c/r.cap)*100;
                g.innerHTML += `<div class="room-card ${c>=r.cap?'full':''}" onclick="openRoomView('${r.no}',${r.cap})">
                    <div class="room-number">${r.no}</div>
                    <div class="room-capacity">${c}/${r.cap}</div>
                    <div class="room-progress"><div class="room-bar ${c>=r.cap?'full':''}" style="width:${pct}%"></div></div>
                </div>`;
            });
        }

        function openRoomView(no, cap) {
            activeRoomNo = no; const inRoom = students.filter(s=>s.room==no);
            document.getElementById('rm-stats').innerText = `Cap: ${cap} | Occ: ${inRoom.length}`;
            const l = document.getElementById('rm-list'); l.innerHTML = '';
            if(inRoom.length === 0) l.innerHTML = '<div style="text-align:center; color:#ccc;">Empty</div>';
            inRoom.forEach(s => { l.innerHTML += `<div class="student-card" onclick="openAdminProfile(${s.id})"><div class="st-name">${s.name}</div></div>`; });
            document.getElementById('room-modal').style.display = 'flex';
        }

        function deleteRoom() {
            if(confirm("Delete Room?")) { rooms = rooms.filter(r=>r.no!==activeRoomNo); saveData(); closeModal('room-modal'); renderRooms(); }
        }

        function addExpense() {
            const d = document.getElementById('exp-desc').value, a = document.getElementById('exp-amt').value;
            if(d && a) { expenses.push({desc:d, amount:parseInt(a), date:new Date().toLocaleDateString()}); saveData(); renderExpenses(); document.getElementById('exp-desc').value=''; document.getElementById('exp-amt').value=''; }
        }
        function renderExpenses() {
            const div = document.getElementById('expense-list'); div.innerHTML='';
            expenses.forEach((e, i) => {
                div.innerHTML += `<div class="expense-card"><div style="flex:1"><b>${e.desc}</b><div style="font-size:0.8rem;color:#777">${e.date}</div></div><div class="exp-amount">- ‚Çπ${e.amount}</div><i class="fa-solid fa-trash exp-del-btn" onclick="deleteExpense(${i})"></i></div>`;
            });
        }
        function deleteExpense(i) {
            if(confirm("Remove Expense?")) { expenses.splice(i, 1); saveData(); renderExpenses(); }
        }

        function updateStats() {
            document.getElementById('total-students').innerText = students.length;
            document.getElementById('total-rooms').innerText = rooms.length;
            
            let income = 0;
            students.forEach(s => { s.payments.forEach(p => { if(p.month === currentMonth) income += parseInt(s.rent || 0); }); });
            let expense = expenses.reduce((acc, curr) => acc + curr.amount, 0);
            
            document.getElementById('stat-income').innerText = "‚Çπ" + income;
            document.getElementById('stat-expense').innerText = "‚Çπ" + expense;
            document.getElementById('stat-profit').innerText = "‚Çπ" + (income - expense);
        }

        function saveData() {
            localStorage.setItem('omSaiStudents', JSON.stringify(students));
            localStorage.setItem('omSaiRooms', JSON.stringify(rooms));
            localStorage.setItem('omSaiExpenses', JSON.stringify(expenses));
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function downloadBackup() {
            const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({students, rooms, expenses}));
            const a = document.createElement('a'); a.href = data; a.download = "hostel_backup.json"; a.click();
        }
        function restoreBackup(i) {
            const r = new FileReader();
            r.onload = e => { 
                const d = JSON.parse(e.target.result); 
                if(d.students) { 
                    localStorage.setItem('omSaiStudents', JSON.stringify(d.students)); 
                    localStorage.setItem('omSaiRooms', JSON.stringify(d.rooms)); 
                    localStorage.setItem('omSaiExpenses', JSON.stringify(d.expenses||[]));
                    location.reload(); 
                }
            };
            r.readAsText(i.files[0]);
        }
        initAdmin();
    </script>
</body>
</html>